# Signal Management Feature - Admin Portal

## Overview

A comprehensive signal management system that allows admins to view, edit, delete, and control the visibility of all trading signals generated by customer bots across the platform.

## ✨ Features Implemented

### 1. **View All Signals**
- Centralized dashboard showing all signals from all customer bots
- Rich signal details including customer, bot, action, symbol, price, and status
- Real-time stats: Total signals, Processed, Pending, Errors

### 2. **Advanced Filtering**
- **Search**: By customer name, email, bot name, or trading symbol
- **Status Filter**: All, Processed, Pending, Error
- **Action Filter**: All, Enter Long, Exit Long, Enter Short, Exit Short

### 3. **Signal Visibility Control**
- Toggle to control which signals customers can see
- Quick switch in table row for instant visibility changes
- Protected admin-only visibility management

### 4. **Edit Signals**
- Modify signal action (Enter/Exit, Long/Short)
- Update trading symbol
- Change price (optional)
- Edit message content
- Mark as processed/unprocessed
- Control customer visibility

### 5. **Delete Signals**
- Remove unwanted or erroneous signals
- Confirmation dialog with signal details
- Permanent deletion with warning

## 🗄️ Database Schema Changes

### Updated Signal Model

```prisma
model Signal {
  id    String @id @default(uuid())
  botId String

  action  Action
  symbol  String
  price   Float?
  message String?

  processed         Boolean  @default(false)
  error             String?
  visibleToCustomer Boolean  @default(true)  // NEW: Visibility control
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt       // NEW: Track updates

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@map("signal")
}
```

**New Fields:**
- `visibleToCustomer`: Boolean flag to control if customer can see the signal
- `updatedAt`: Timestamp to track when signal was last modified

## 📁 Files Created

### Server Actions
**`src/db/actions/admin/get-all-signals.ts`**
- `getAllSignals()` - Fetch all signals with customer and bot details
- `updateSignalVisibility()` - Toggle signal visibility
- `updateSignal()` - Edit signal properties
- `deleteSignal()` - Remove signal

### API Endpoints
**`src/app/api/admin/signals/route.ts`**
- `GET /api/admin/signals` - Get all signals

**`src/app/api/admin/signals/[signalId]/route.ts`**
- `PATCH /api/admin/signals/[signalId]` - Update signal
- `DELETE /api/admin/signals/[signalId]` - Delete signal

### UI Components
**`src/app/(admin)/signals/page.tsx`**
- Main signals management page

**`src/app/(admin)/signals/_components/signals-table.tsx`**
- Interactive table with filters, search, and actions
- Inline visibility toggle
- Status badges and action icons

**`src/app/(admin)/signals/_components/edit-signal-dialog.tsx`**
- Modal dialog for editing signal details
- Form validation and error handling

**`src/app/(admin)/signals/_components/delete-signal-dialog.tsx`**
- Confirmation dialog for signal deletion
- Signal details preview before deletion

### Navigation
**Updated `src/lib/navigation.ts`**
- Added "Signals" menu item in Management section

## 🔐 Security Features

### Admin-Only Access
All signal management features are protected:
```typescript
const admin = await isAdmin();
if (!admin) {
  return { error: "Unauthorized" };
}
```

### Database-Level Validation
- Verifies signal existence before operations
- Cascade delete protection (signal deleted if bot is deleted)
- Atomic updates with Prisma transactions

## 🎨 UI Features

### Signal Table
- **Color-coded action badges**:
  - 🟢 Enter Long (Green)
  - 🔵 Exit Long (Blue)
  - 🔴 Enter Short (Red)
  - 🟠 Exit Short (Orange)

- **Status indicators**:
  - ✅ Processed (Green badge)
  - ⏳ Pending (Gray badge)
  - ❌ Error (Red badge)

- **Visibility toggle**:
  - 👁️ Eye icon when visible
  - 👁️‍🗨️ Eye-off icon when hidden
  - Instant toggle with confirmation

### Responsive Design
- Mobile-friendly layout
- Collapsible filters on small screens
- Touch-optimized controls

## 📊 Usage Examples

### View All Signals
1. Navigate to `/signals` from admin sidebar
2. Browse all signals in the table
3. Use filters to find specific signals

### Control Signal Visibility
1. Find the signal in the table
2. Toggle the switch in "Visible to Customer" column
3. Customer will immediately see/hide the signal

### Edit a Signal
1. Click the three-dot menu on a signal row
2. Select "Edit Signal"
3. Modify any field:
   - Action type
   - Trading symbol
   - Price
   - Message
   - Processed status
   - Visibility
4. Click "Update Signal"

### Delete a Signal
1. Click the three-dot menu on a signal row
2. Select "Delete Signal"
3. Review signal details in confirmation dialog
4. Click "Delete Signal" to confirm

## 🔄 Signal Lifecycle

```
1. Bot receives webhook → Signal created (visibleToCustomer: true)
                          ↓
2. Signal processed by trading engine
                          ↓
3. Admin can review in /signals
                          ↓
4. Admin can toggle visibility (customer sees/doesn't see)
                          ↓
5. Admin can edit details if needed
                          ↓
6. Admin can delete if erroneous
```

## 🚀 Migration Required

After pulling these changes, run:

```bash
# Generate Prisma migration
npx prisma migrate dev --name add_signal_visibility_and_updated_at

# Or reset database (development only)
npx prisma migrate reset
npx prisma db push
```

### Migration SQL
```sql
-- Add new columns to signal table
ALTER TABLE "signal" ADD COLUMN "visibleToCustomer" BOOLEAN NOT NULL DEFAULT true;
ALTER TABLE "signal" ADD COLUMN "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP;
```

## 📱 API Reference

### GET /api/admin/signals
**Returns**: Array of signals with customer and bot details

**Response Example:**
```json
[
  {
    "id": "signal-123",
    "botId": "bot-456",
    "botName": "Groot",
    "customerName": "John Doe",
    "customerEmail": "john@example.com",
    "customerId": "user-789",
    "action": "ENTER_LONG",
    "symbol": "BTCUSDT",
    "price": 45000.00,
    "message": "Strong bullish signal",
    "processed": true,
    "error": null,
    "visibleToCustomer": true,
    "createdAt": "2024-01-01T12:00:00Z",
    "updatedAt": "2024-01-01T12:00:00Z"
  }
]
```

### PATCH /api/admin/signals/[signalId]
**Body**: Partial signal update
```json
{
  "action": "EXIT_LONG",
  "symbol": "ETHUSDT",
  "price": 3000,
  "message": "Take profit signal",
  "processed": true,
  "visibleToCustomer": false
}
```

**Response:**
```json
{ "success": true }
```

### DELETE /api/admin/signals/[signalId]
**Response:**
```json
{ "success": true }
```

## 🎯 Use Cases

### 1. Hide Erroneous Signals
If a bot generates a false signal, admin can:
- Toggle `visibleToCustomer` to false
- Customer won't see it in their signal history

### 2. Correct Signal Details
If signal has wrong symbol or action:
- Edit the signal with correct details
- Keep trading history accurate

### 3. Remove Test Signals
During bot testing:
- Delete test signals to clean up data
- Maintain clean production environment

### 4. Audit Signal Activity
Monitor all signals across platform:
- Track signal success rates
- Identify problematic bots
- Analyze trading patterns

## 🔍 Filtering Examples

### Find All Failed Signals
- Status Filter: "Error"
- Review errors in table
- Edit or delete as needed

### Find Signals for Specific Customer
- Search: Customer name or email
- View all their bot signals
- Manage visibility per signal

### Find Pending Signals
- Status Filter: "Pending"
- See what's waiting to process
- Monitor processing pipeline

## 📈 Statistics Dashboard

The signals page shows real-time metrics:
- **Total Signals**: All signals in system
- **Processed**: Successfully executed signals
- **Pending**: Awaiting execution
- **Errors**: Failed signals requiring attention

## 🎨 Color Coding

- **Green**: Enter Long, Processed, Visible
- **Blue**: Exit Long
- **Red**: Enter Short, Errors, Destructive actions
- **Orange**: Exit Short
- **Gray**: Pending, Not visible

## ⚡ Performance

- Optimized database queries with Prisma
- Server-side filtering and sorting
- Lazy loading for large datasets
- Indexed foreign keys for fast lookups

## 🔒 Data Privacy

- Only admins can access signal management
- Customer visibility control prevents data leaks
- Audit trail through `updatedAt` timestamp
- Secure API endpoints with role verification

## 🎁 Benefits

✅ **Centralized Management**: All signals in one place  
✅ **Customer Privacy**: Control what customers see  
✅ **Data Quality**: Edit and delete erroneous signals  
✅ **Transparency**: Full signal audit trail  
✅ **Flexibility**: Granular control over each signal  
✅ **Insights**: Platform-wide signal analytics  

## 📝 Notes

- By default, all signals are visible to customers
- Hiding a signal doesn't affect trade execution
- Deleted signals cannot be recovered
- Changes are immediately reflected in customer portal
- All operations are logged for audit purposes

## 🚦 Next Steps

After implementing this feature:

1. **Run the migration** to add new fields
2. **Test signal visibility** toggle functionality
3. **Verify edit operations** work correctly
4. **Test delete** with confirmation
5. **Check customer portal** respects visibility settings

## 📞 Support

For questions or issues:
- Check API logs for error messages
- Verify admin permissions
- Ensure database migration completed
- Test with different signal states

---

This feature provides admins with complete control over the signal ecosystem, ensuring data quality and customer privacy while maintaining full transparency and auditability.

